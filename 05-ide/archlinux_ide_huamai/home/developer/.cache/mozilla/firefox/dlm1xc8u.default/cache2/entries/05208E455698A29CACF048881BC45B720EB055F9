(function(window, undefined) {
  var protocol = window.location.protocol;
  var localUreadData=[],hasNewMsg=false,hasGetData=false;
  try {
    var aaInput = document.createElement('input');
    aaInput.type = "hidden";
    aaInput.id = "aa_g_data_ids";
    document.getElementsByTagName('body')[0].appendChild(aaInput);
  } catch(e) {};
  var defaults = {
    realtime: protocol+'//s{0}-im-notify.csdn.net'
    , api: protocol+'//svc-notify.csdn.net'
    , app:'http://msg.csdn.net'
    , space: protocol+'//my.csdn.net/'
    , count: 5
    , subCount: 5
    , staticUrl: protocol+'//csdnimg.cn/rabbit/notev2/'
    , cssUrl: 'css/style.css'
    , 'realtime.js': 'js/realtime.js' // base staticUrl
    // , 'channel': 'message'
    , 'socket.io.js': 'js/socket.io.js'
    // , 'socket.io options': { transports: ["xhr-polling", "jsonp-polling"]}
  }
  //
  , csdn = window.csdn || (window.csdn = {})
  , isShowMsg = true
    // && location.search === '?smsg=1' // DEV
  , friendlyErrors = {
    'timeout': 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ï¼'
    , 'abort': 'è¯·æ±‚è¢«ä¸­æ­¢ï¼'
    , 'parsererror': 'è§£æé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ï¼'
    , 'No id supplied': 'æœªç™»å½•æˆ–ç™»å½•è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•ï¼'
    , 'locked': ''
  }
  ;
var getCookie =function (objName){//è·å–æŒ‡å®šåç§°çš„cookieçš„å€¼
      var arrStr = document.cookie.split("; ");
      for(var i = 0;i < arrStr.length;i ++){
      var temp = arrStr[i].split("="); 
      if(temp[0] == objName) return decodeURI(temp[1]);
      } 
  }
//

  if (Function.prototype.bind === undefined) {
    Function.prototype.bind = function (ctx) {
      var self = this;
      return function () {
        self.apply(ctx, [].slice(arguments, 0));
      };
    };
  }

  function log() {
    if (typeof console !== 'undefined') {
      Function.prototype.apply.call(console.log, console, Array.prototype.slice.call(arguments));
    }
  }

  var $
    , currUser = { username: '' } //ç™»å½•ç”¨æˆ·å¯¹è±¡
    ;

  csdn.note = function(conf) {
    $ = jQuery;

    //é…ç½®é¡¹
    this.conf = conf;

    //DomèŠ‚ç‚¹
    this.Dom = {};

    //åˆå§‹åŒ–
    this.init();
  };

  csdn.note.prototype = {
    /*
     * ã€åˆå§‹åŒ–å…¥å£ã€‘
     */
    init: function() {
      var self = this, opts = self.conf;
      opts.wrap = $('#' + opts.wrapId);
      if(typeof opts.count === 'string') {
        opts.count = parseInt(opts.count, 10) || undefined;
      }
      if(typeof opts.subCount === 'string') {
        opts.subCount = parseInt(opts.subCount, 10) || undefined;
      }
      
      self.conf = $.extend({}, defaults,
        //
        opts);

      //åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨
      self.getDoms();

      //æ£€æŸ¥ç”¨æˆ·ç™»å½•
      self.checkLogin(function(data) {
        //
        if(isShowMsg) {
          //åŠ è½½æ ·å¼ä¸äº‹ä»¶
          self.loadCss(self.staticUrl(self.conf.cssUrl));
          self.addEvent();
        }
        // åˆå§‹åŒ–å®æ—¶ç³»ç»Ÿ
        self.initRealtime();
      });
    },
    loadCss : function(src, callback){
      $('<link rel="stylesheet" type="text/css"/>').appendTo('head:first').load(function(){
        callback && callback();
      }).attr('href', src);
    },
    /**
     * æ˜¾ç¤ºæŒ‡å®šèŒƒå›´çš„.loadingå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œåå°†éšè—loading
     * @param  {String} [selector=''] cssé€‰æ‹©å™¨ï¼Œé…åˆctxå†³å®šä½¿ç”¨å“ªä¸ª.loading
     * @param  {jQuery Object} ctx=wrap .loadingæ‰€åœ¨çš„ä¸Šä¸‹æ–‡
     * @return {Function(Function(Boolean loading) doneCallback)}
     * éšè—å·²æ˜¾ç¤ºçš„.loadingå…ƒç´ ï¼Œå¹¶åœ¨éšè—å®Œæ¯•åè°ƒç”¨doneCallback
     * loadingå‚æ•°ç”¨äºæŒ‡ç¤º.loadingå½“å‰è¿˜åœ¨æ˜¾ç¤ºä¸­ï¼ˆå…±äº«loadingæ—¶ä¼šæœ‰è¿™ç§çŠ¶å†µï¼‰
     */
    loading: function (selector, ctx) {
      var self = this
        , ctx = typeof selector === 'object' ? selector : self.Dom.wrap
        , selector = typeof selector === 'string' ? selector : ''
        , el = $(selector + ' .loading', ctx)
        , num = (el.data('loadingCount') || 0) + 1
        , completed = false
        ;
      el.show().data('loadingCount', num);
      return function (callback) {
        if(completed) return;
        num = el.data('loadingCount') - 1;
        if(num <= 0) {
          num = 0;
          el.fadeOut('fast', function(){
            el.hide(); // jQuery 1.4.3å­˜åœ¨çš„bugï¼Œå½“fadeOutå…ƒç´ çš„çˆ¶å…ƒç´ ä¸å¯è§†æ—¶ï¼ŒfadeOutä¸ä¼šæ”¹å˜å…ƒç´ display
            callback && callback(false);
          });
        } else {
          callback && callback(true);
        }
        el.data('loadingCount', num);
        completed = true;
      }
    },
    emptyCb: function () {},
    wrapCb: function () {
      var args = [].slice.call(arguments, 0);
      return function (callback) {
        callback && callback.apply(args);
      };
    },
    toggleEmpty: function (toggle, ctx, list) {
      ctx = typeof ctx === 'string' ? $(ctx, this.Dom.wrap) : ctx;
      $('.empty', ctx).toggle(toggle && !$(list, ctx)[0]);
    },
    staticUrl: function (url) {
      // TODO å¯é…ç½®ä¸åŒurlä½¿ç”¨ä¸åŒæ—¶é—´æˆ³
      return this.conf.staticUrl + url + '?4d63d1f';
    },

    on: function (type, data, handler) {
      this.Dom.wrap.bind(type, data, handler);
      return this;
    },
    emit: function (type, params) {
      this.Dom.wrap.triggerHandler(type, params)
      return this;
    },
    lock: function (id, callback) {
      var self = this;
      if(self.lockers === undefined) {
        self.lockers = {};
      }
      if(!id || !self.lockers[id]) { // idä¸ºnull ç©ºç™½å­—ç¬¦ä¸²ç­‰è¡¨ç¤ºä¸ä½¿ç”¨lock
        self.lockers[id || ''] = true;
        callback(null, function () {
          self.lockers[id || ''] = false;
        });
      } else {
        callback('locked', self.emptyCb);
      }
    },
    /**
     * å¡«å……this.Domï¼Œå»ºç«‹å¿…è¦çš„èƒŒæ™¯iframe
     * æ³¨æ„ï¼šæ­¤æ—¶csså°šæœªåŠ è½½ï¼Œæ‰€ä»¥æ ·å¼éƒ½æ²¡ç”Ÿæ•ˆ
     */
    getDoms: function() {
      var wrap = this.Dom.wrap = this.conf.wrap
        , tip = wrap.next()
        ;
      if(!tip.is('.csdn_notice_tip')) {
        tip = $('.csdn_notice_tip');
      }
      this.Dom.tip = tip;
      this.Dom.btn = this.conf.btn;
      wrap.append('<iframe src="about:block" frameborder="0" allowTransparency="true" style="z-index:-1;position:absolute;top:0;left:0;width:100%;height:100%;background:transparent"></iframe>');
      return this;
    },
    resetPosition: function () {
      var self = this
        , offset = self.Dom.btn.offset()
        ;
      self.Dom.wrap.css({
        left: offset.left - 212 + 'px',
        top: offset.top + 25 + 'px'
      });
      self.Dom.tip.css({
        left: offset.left - 72 + 'px',
        top: offset.top + 18 + 'px'
      });
    },
    changeToNickname: function (ctx) {
      var self = this;
      ctx = ctx || self.Dom.wrap;
      var users = $('.user_name', ctx).filter(function(){
        return !$(this).data('nickname');
      });
      if(users[0]) {
        $.getJSON('//passport.csdn.net/get/nick?callback=?', {
          users: users.map(function(){ return this.innerHTML; }).get().join()
        }, function(data){
          var dataList=data.data;
          users.each(function (i) {
            for(var j=0;j<dataList.length;j++){
              if(users[i].innerHTML == dataList[j].u){
               this.innerHTML = dataList[j].n;
                $(this).data('nickname', true);
                break;
              }
            }
          });
        });
      }
    },
    addEvent: function() {
      var self = this
        , unreads = -1
        , hasReadedItems = false
        , keepUnread = false
        , notifications
        ;
      self.unreads = unreads;
      self.initPanel();
      notifications = $('.notifications', self.Dom.wrap);

      self.Dom.btn.click(function(e, params) {
        self.emit('panel_showed', params);
        if(self.Dom.wrap.toggle().is(':visible')) {
          self.Dom.tip.hide();
        } else {
          self.emit('tip_showing');
        }
        return false;
      });
      $(window).resize(function(e){
        self.resetPosition();
      });
      $(document).click(function(e) {
        var t = e.target;
        try {
          if(!$.contains(self.Dom.wrap[0], t) && !$.contains(self.Dom.tip[0], t)) {
            $(document).trigger('notify-hide');
          }
        } catch(e) {
          log(e);
        }
      });

      $('.notice_list_con .notice_content', self.Dom.wrap).bind('click', function (e) {
        var target = e.target
           , item = $(target).parents(".list")
           , index = item.index()
           , detail = $('.detail_con .notice_content > *:eq(' + index + ')', self.Dom.wrap)
           ;


        item.hasClass("unread")&&self.setReaded([{containIds:item.attr("data-ids").split(",")}],function(data){
          keepUnread = true;
          item.removeClass('unread');
          //å»é™¤å·²è¯»id
          var _strReadedIds = item.attr("data-ids");
          var _unread = [],_item={};
          for(var i=0;i<localUreadData.length;i++){
            _item = localUreadData[i];
            if(_item.containIds.join() === _strReadedIds){
              localUreadData.splice(i,1);
            }
          }
          self.emit('tip_showing');
        });

        detail.addClass('curr').show().siblings().removeClass('curr').hide();
        if(!item.hasClass("noslide")){
          self.goSlide(notifications.eq(0), notifications.eq(1), 'right').emit('detail_showed', [detail, index]);
        }
        if(item.hasClass("action")&&target.tagName=="A"){
          self.doaction({
            id:$(item).attr("data-ids").split(",")[0]*1,
            dataApi:$(".callback",item).attr("data-api"),
            args:$(target).attr("data-api")
          },function(err, data){
            $(".callback",item).html(data.msg);
            $(".callback",detail).html(data.msg);
          });
        }
      });

      $('.detail_con .notice_content', self.Dom.wrap).delegate('.item_title', 'click', function (e) {
        var target = e.target
          , item = $(target).parents(".detail_list")
          , index = item.index()
          , list = $('.notice_list_con .notice_content > *:eq(' + index + ')', self.Dom.wrap);
        
        if(item.hasClass("action")&&target.tagName=="A"){
          self.doaction({
            id:$(item).attr("data-ids").split(",")[0]*1,
            dataApi:$(".callback",item).attr("data-api"),
            args:$(target).attr("data-api")
          },function(err, data){
            $(".callback",item).html(data.msg);
            $(".callback",list).html(data.msg);
          });
        }
      });

      //å½“trigger clickæ—¶ï¼Œä¼šå°†äº‹ä»¶æºå¯¹è±¡å˜æˆè¿™ä¸ªcloseèŠ‚ç‚¹ï¼Œæ‰°ä¹±äº†å…¶å®ƒjsçš„åˆ¤æ–­é€»è¾‘ã€‚
      function hidecb(){
        self.Dom.wrap.hide();
        self.emit('tip_showing');
      }

      $(document).bind("notify-hide",function(){
        hidecb();
      });

      $('.csdn_note .close1', self.Dom.wrap).click(function () {
        hidecb();
      });

      $('.go_back', self.Dom.wrap).click(function () {
        self.goSlide(notifications.eq(1), notifications.eq(0), 'left');
        self.emit('panel_showed');
      });
      //$('.read_all', self.Dom.wrap).click(function () {
      //  self.setAllReaded();
      //  return false;
      //});
      $('.prvnote, .nextnote', self.Dom.wrap).click(function () {
        var el = $(this);
        if(el.hasClass('disabled')) return;
        var form = $('.detail_con .notice_content .curr', self.Dom.wrap)
          , to = form[el.hasClass('prvnote') ? 'prev' : 'next']()
          , index = to.index()
          ;
        if (~index) {
          $('.notice_list_con .notice_content > *:eq(' + index + ')', self.Dom.wrap).removeClass('unread');
          $([form[0], to[0]]).toggleClass('curr');
          self.goSlide(form, to, el.hasClass('prvnote') ? 'left' : 'right').emit('detail_showed', [to, index]);
        }
      });

      self.on('panel_showed', function (e, showDetail) {
        self.resetPosition();

        if (!hasReadedItems) {
          $('.notice_content', self.Dom.wrap).empty();
          self.getAllReaded(self.showListCbWrap(function (err, data, loading) {
            hasReadedItems = true;
          }));
        }
        if(showDetail&&showDetail.data){
          self.fillList("prepend",showDetail);
          self.slideReset();
          hasGetData = true;
          hasNewMsg = false;
        }
        // æ˜¾ç¤ºé¢æ¿å†…å®¹
        else if (localUreadData.length > 0&&hasNewMsg) {
          hasNewMsg = false;
          self.getUnreads(self.showListCbWrap(function (err, data, loading) {
              localUreadData = data.data;
              hasNewMsg = false;
              self.emit('tip_showing');
          }));
        }
        
        if (hasGetData) {
          self.Dom.wrap.one('list_showed', function (e, err) {
            if (err) {
              self.error(err);
            } else {
              if(showDetail) {
                var unreadsItem = $('.notice_list_con .unread', self.Dom.wrap);
                if(unreadsItem.length === 1) {
                  unreadsItem.trigger('click');
                }
              }
            }
          });
        }
      }).on('detail_showed', function (e, detail, index) {
        // æ˜¾ç¤ºé€šçŸ¥è¯¦æƒ…
        $('.detail_con .prvnote', self.Dom.wrap).toggleClass('disabled', !(index > 0));
        $('.detail_con .nextnote', self.Dom.wrap).toggleClass('disabled', !detail.next()[0]);
        if (!detail.data('loaded') && !$('dd', detail)[0] && !$('.empty:visible', detail)[0] && !$('.loading:visible', detail)[0]) {
          self.getDetail(detail);
        }
      }).on('tip_showing', function () {
        keepUnread = true;
        // if ($('.notice_list_con', self.Dom.wrap).css('display') !== 'none') {
        //   $('.notice_list_con .notice_content .unread', self.Dom.wrap).removeClass('unread');
        // }
        self.initBtn();
        if (localUreadData.length > 0) {
          self.resetPosition();
          $('strong', self.Dom.tip.show()).html(localUreadData.length);
          $('.icon-hasnotes',self.Dom.btn).show();
          //æ´¾å‘ç»™toolbar
        }else{
          $('.icon-hasnotes',self.Dom.btn).hide();
        }
        $(document).trigger("toolbar-setNotesNum",localUreadData.length);
      }).on('receive_unreads', function (e, data) {
        
        data.initUnreadIds&&(localUreadData = data.initUnreadIds);
        // æ”¶åˆ°æœªè¯»æ¶ˆæ¯å®æ—¶é€šçŸ¥ typeof data === number123123

        //data.realtimeMsg&&localUreadData = data.realtimeMsg;
        //self.unreads = unreads = (unreads === -1 ? 0 : unreads) + data;

        if (self.Dom.wrap.is(':visible')) {
          if($('.notice_list_con', self.Dom.wrap).is(':visible')){
            if(data.realtimeMsg){
              self.emit('panel_showed',{
                data:data.data
              });
            }else{
              self.emit('panel_showed');
            }
          }
        } else {
          self.emit('tip_showing');
        }
      }).on('receive_setreaded', function (e, data) {
        var _len = localUreadData.length;
        // æ”¶åˆ°è®¾ç½®ä¸ºå·²è¯»å®æ—¶é€šçŸ¥ typeof data === array or number
        if (keepUnread) {
        } else { // TODO å¦‚æœç„¦ç‚¹åœ¨å½“å‰æµè§ˆå™¨çª—å£ï¼Œä»€ä¹ˆéƒ½ä¸åš
          // éæŸ¥çœ‹çª—å£æ”¶åˆ°å·²è¯»é€šçŸ¥æ—¶éœ€è¦é‡ç½®çŠ¶æ€ï¼Œä»¥ä¾¿å†æ¬¡æ‰“å¼€æ—¶èƒ½æ­£ç¡®æ˜¾ç¤ºé€šçŸ¥
          self.unreads = _len;
          hasReadedItems = false;
        }
        
        if (_len <= 0) {
          self.Dom.tip.hide();
          $(".icon-hasnotes",self.Dom.btn).hide();
        }
        $('strong', self.Dom.tip).html(_len);
      });

      $('.close2', self.Dom.tip).click(function () {
        self.Dom.tip.hide();
        self.setReaded([], function(){
        });
      });

      $('.tip_text', self.Dom.tip).click(function () {
        self.Dom.btn.trigger('click'
          // , ['Show one and only unread detail'] // ç‚¹å‡»æœªè¯»æ¶ˆæ¯æç¤ºæ¡†åï¼Œå¦‚æœæœªè¯»æ¡ç›®åªæœ‰ä¸€æ¡ï¼Œåˆ™è‡ªåŠ¨è¿›å…¥å“ªä¸€æ¡æœªè¯»
        );
      });


      return self;
    },
    initBtn: function(){
      if(this.conf.btn.find(".icon-hasnotes").length<=0){
        this.conf.btn.html('<div class="icon-hasnotes" style="display:none"></div>');
      }
    },
    //<span class="title"><a href="' + this.conf.app + '/" target="_blank" class="read_all">å…¨éƒ¨è®¾ä¸ºå·²è¯»</a><a href="' + this.conf.app + '/" target="_blank" class="go_all">æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥</a></span>\
    initPanel: function () {
      $('.box', this.Dom.wrap).append('\
<div class="notifications notice_list_con curr">\
  <div class="menu_title">\
    <span class="title"><a href="http://msg.csdn.net/letters" target="_blank" class="read_all">æŸ¥çœ‹æ‰€æœ‰ç§ä¿¡</a><a href="http://msg.csdn.net" target="_blank" class="go_all">æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥</a></span>\
  </div>\
  <div class="loading"></div>\
  <div class="empty">æš‚æ²¡æœ‰æ–°é€šçŸ¥</div>\
  <div class="notice_content"></div>\
</div>\
<div class="notifications detail_con" style="display: none">\
  <div class="menu_title">\
    <span class="title">\
      <a class="go_back" href="javascript:void 0;">è¿”å›é€šçŸ¥åˆ—è¡¨</a>\
      <a class="notifications_page_none nextnote" href="javascript:void 0;">ä¸‹ä¸€æ¡</a>\
      <a class="notifications_page prvnote" href="javascript:void 0;">ä¸Šä¸€æ¡</a>\
    </span>\
  </div>\
  <div class="notice_content" style="overflow-y: scroll; height: 250px;"></div>\
</div>\
<div class="error"></div>');
    },
    fillList: function(insert, data) {
      if(!data || !data.data || !data.data.length) return;
      data = data.data;
      var self = this
        , wrap = self.Dom.wrap
        , list = new Array(data.length)
        , details = new Array(data.length)
        ;
      $.each(data, function (i, v) {
        var action = v.isaction?" action ":"";
        var isslide = !v.isslide?" noslide ":"";
        var dataIds=(function(){
          var _ids = [];
          for(var i=0,len=v.containIds.length,item=v.containIds;i<len;i++){
            _ids.push(item[i]*1);
          }
          return _ids.join(",");
        })();
        try
        {
          var aaaInput = document.getElementById("aa_g_data_ids");
          var cv = aaaInput.value;
          if (cv.indexOf(dataIds + "|") >= 0) {
            return;
          }
          aaaInput.value += dataIds + "|";
        } catch(e) {}
        list[i] = '\
<dl data-ids="'+dataIds+'" class="list rev_type'+v.type + (insert === 'append' ? '' : ' unread')+isslide+action+'" style="/*display: none*/">\
  <dt>\
    <i></i>\
    <span class="item_title">' + v.title + '</span>\
    <span class="count_down">' + v.time + '</span>\
  </dt>\
</dl>';
        var remain = v.containIds.length - self.conf.subCount;
        details[i]='\
<div style="/*display: none*/">\
  <dl class="detail_list rev_type' + v.type +isslide+action+ '" data-ids="' + v.containIds.join() + '">\
    <dt>\
      <i></i>\
      <span class="item_title">' + self.ubbDecode(v.longTitle) + '</span>\
      <span class="count_down"></span>\
    </dt>\
  </dl>\
  <div class="loading"></div>\
  <div class="empty">æš‚æ²¡æœ‰æ–°é€šçŸ¥</div>\
  <a class="notifications_more" target="_blank">æŸ¥çœ‹å…¶å®ƒ 0 æ¡</a>\
</div>';
      });
      $('.notice_list_con .notice_content', wrap)[insert](list.join(''));
      $('.detail_con .notice_content', wrap)[insert](details.join(''));
      self.changeToNickname();
    },
    fillDetail: function (detail, data) {
      if(!data || !data.data || !data.data.length) return;
      var bodyTpl = data.bodyTpl
        , self = this
        , dl = $('dl', detail)
        , html
        ;
      data = data.data;

      if (data[0].body) {
        html = $.map(data, function (v) {
          return self.feTemplate(bodyTpl).render({
            userlink:self.conf.space + v.from_user,
            from_user:v.from_user,
            body:self.ubbDecode(v.body).replace(/</g, '&lt;').replace(/&lt;a/g, '<a').replace(/&lt;\//g, '</'), //self.ubbDecode(v.body).replace(/</g, '&lt;').replace(/>/g, '&gt;'),
            time:v.time
          });
        }).join('');
        if (html) {
          dl.append(html);
          var remain = dl.attr('data-ids').split(',').length - data.length
            , url = data[0].url
            ;
          if(remain > 0 && url) {
            $('.notifications_more', detail).html(function (i, v) {
              return v.replace(/\d+/g, remain);
            }).attr('href', url).addClass('block');
          }
        }
      }
      if (!html) {
        $('dt .count_down', detail).html(data[0].time);
        detail.data('loaded', true);
      }
      self.changeToNickname(dl);
    },
    /**
     * æ˜¾ç¤ºåˆ—è¡¨çš„å›è°ƒåŒ…è£…ã€‚å’ŒgetUnreadsï¼ŒgetAllReadedé…åˆä½¿ç”¨ï¼ŒåŒ…å«ä¸€äº›é€šç”¨çš„æ“ä½œï¼Œä»¥åŠè§¦å‘å¿…è¦çš„äº‹ä»¶
     * @param  {Function} callback å½“æ­£å¸¸è·å–åˆ°æ•°æ®æ—¶çš„å›è°ƒ
     * @return {Function} åŒ…è£…ä¹‹åçš„å›è°ƒå‡½æ•°
     */
    showListCbWrap: function (callback) {
      var self = this;
      return function (err, data, loading) {
        if (err) {
          self.emit('list_showed', [err]);
        } else {
          callback && callback(err, data, loading);
          if (!loading) {
            var list = $('.notice_list_con .notice_content > .list', self.Dom.wrap);
            // è°ƒæ•´å¯è§æ¶ˆæ¯æ•°é‡
            if (list.filter(':visible').length === 0) {
              var n = list.filter('.unread').length;
              if(n < self.conf.count) {
                n = self.conf.count;
              }
              list.slice(n).remove();
              $('.detail_con .notice_content > *', self.Dom.wrap).slice(n).remove();
            }
            list.show();
            self.slideReset();
            self.emit('list_showed');
          }
        }
      };
    },
    error: function (msg) {
      var self = this, func = arguments.callee;
      if(func.init === undefined) {
        func.ele = $('.error', self.Dom.wrap);
        self.on('panel_showed detail_showed', function () {
          func.ele.hide();
        });
        func.init = true;
      }
      msg = friendlyErrors[msg] !== undefined ? friendlyErrors[msg] : msg;
      func.ele.toggle(!!msg).html(msg);
    },
    invokeAPI: function (url, params, opts, callback) {
      var self = this
        , opts = opts || {}
        , callback = callback || self.emptyCb
        ;
      self.lock(opts.lock === undefined || opts.lock ? url : null, function (err, unlock) {
        if(err) {
          callback(err);
          return;
        }
        var done = opts.loading === undefined || opts.loading ? self.loading(opts.container) : self.wrapCb(false)
          , data
          , completed = false
          , complete = function (xhr, status) {
            if(completed) return;
            done(function (loading) {
              if(status && status !== 'success') {
                callback(status, null, loading);
              } else {
                if(data.status !== 200) {
                  callback(data.error || data.status, data, loading);
                } else {
                  if(opts.list) {
                    // /detail/i.test(url) && (data.data = []); // DEV
                    self.toggleEmpty(!loading && data.data && !data.data.length, opts.container, opts.list);
                  }
                  callback(null, data, loading);
                }
              }
              unlock();
              completed = true;
            });
          }
          ;
        setTimeout(function () {
          complete(null, 'timeout');
        }, 20000);
        $.ajax({
          url: self.conf.api + url,
          data: params,
          dataType: 'jsonp', // TODO jsonpæ–¹å¼è°ƒç”¨ä¸èƒ½äº§ç”Ÿæ­£ç¡®çš„timeouté”™è¯¯ç­‰ï¼Œè€ƒè™‘æ¢æˆæ”¯æŒè·¨åŸŸçš„xhr(åœ¨ff chrome ie8+)
          success: function (json) {
            if(completed) return;
            data = json;
          },
          complete: complete
        });
      });
    },
    getUnreads: function (callback) {
      var self = this;
      self.invokeAPI('/get_unread?jsonpcallback=?', {}, {
        container: '.notice_list_con',
        list: '.notice_content > .list'
      }, function (err, data, loading) {
        self.fillList('prepend', data);
        callback && callback(err, data, loading);
      });
    },
    doaction : function(data,callback){
      var self = this;
      self.invokeAPI('/do_action?jsonpcallback=?', {
          id:data.id,
          dataApi:data.dataApi+"?me="+currUser.username+'&'+data.args,
        }, {
      }, function (err, data, loading) {
        callback && callback(err, data, loading);
      });
    },
    getAllReaded: function (callback) {
      var self = this;
      self.invokeAPI('/get_all?jsonpcallback=?', {
        username: currUser.username,
        status: 1,
        count: self.conf.count || 5,
        subcount: self.conf.subcount || 5
      }, {
        container: '.notice_list_con',
        list: '.notice_content > .list'
      }, function (err, data, loading) {
        self.fillList('append', data);
        callback && callback(err, data, loading);
      });
    },
    setAllReaded: function(){
     if(!localUreadData.length){
        return;
     }
     this.setReaded([],function(){
        $(".csdn_note .unread").each(function(i){
           $(this).removeClass("unread");
           localUreadData=[];
        });
     });
    },
    setReaded: function (data, next) {
      var self = this;
      self.invokeAPI('/set_readed?jsonpcallback=?', {
        ids: $.map(data, function (i) {
          return i.containIds.join();
        }).join()
      }, {
        loading: false
      },function(data){
        next&&next(data);
      });
    },
    getlocalUnread: function(){
      return localUreadData;
    },
    isGetAll: function(){
      return hasGetData;
    },
    isHasNewMsg: function(){
      return hasNewMsg;
    },
    getDetail: function(detail, start, limit){
      var self = this
        , ids = $('dl', detail).attr('data-ids').split(',')
        ;
      start = start || 0;
      limit = limit || self.conf.subCount;
      if (ids.length > 0) {
        self.invokeAPI('/get_details?jsonpcallback=?', {
          ids: ids.slice(start, start + limit).join()
        }, {
          container: detail,
          list: 'dl > dd',
          lock: false
        }, function (err, data) {
          if (err) {
            self.error(err);
          } else {
            self.fillDetail(detail, data);
          }
        });
      }
    },
    /**
     * åŠ¨ç”»åˆ‡æ¢
     * @param  {jQuery Object} from     åŠ¨ç”»å¼€å§‹çš„å…ƒç´ 
     * @param  {jQuery Object} to       åŠ¨ç”»ç»“æŸçš„å…ƒç´ 
     * @param  {String} direction       toåœ¨fromçš„å·¦è¾¹è¿˜æ˜¯å³è¾¹, left right
     */
    goSlide: function(from, to, direction) {
      var self = this
        , speed = 110
          // + 3000 // DEV
        , offsetW = from.width()
        , content = to.parents('.notice_content:first')
        , fromComplete, toComplete
        ;

      self.emit('goSliding');

      if (!to.hasClass('curr')) {
        from.removeClass('curr');
        to.addClass('curr');
      }

      from.css({
        position: 'relative'
      });

      to.css({
        position: 'absolute'
        , top: 0
        , left: (direction === 'left' ? -offsetW : offsetW) + 'px'
        , width: offsetW
      }).show();

      content.height(function (i, v) {
        return v - from.height() + Math.max(from.height(), to.height());
      });

      fromComplete = function () {
        from.css('position', '').hide();
      };
      from.animate({
        left: (direction === 'left' ? offsetW : -offsetW) + 'px'
      }, speed, fromComplete);

      toComplete = function () {
        to.css({
          position: ''
          , top: ''
          , left: ''
        });
        content.css('height', '');
      };
      to.animate({ left: 0 }, speed, toComplete);

      self.Dom.wrap.one('goSliding', function () {
        from.stop();
        fromComplete.call(from[0]);
        to.stop();
        toComplete.call(to[0]);
      });

      return this;
    },
    slideReset: function() {
      var self = this
        , container = $('.notice_list_con .notice_content', self.Dom.wrap)
        , items = container.children().filter(':visible')
        ;
      $('.notifications', this.Dom.wrap).eq(0).addClass('curr').show().end()
        .slice(1).hide();
        ;
      if(items.length > self.conf.count) {
        // container.css({
        //   overflow: 'auto'
        //   , height: '255px'
        // });
        container.addClass("hover-overflow");
      }
    },
    /*
     * ã€LOGICã€‘æ£€æŸ¥ç™»å½•
     */
    checkLogin: function(callback) {
        try{
          currUser.username = getCookie("UserName") || currUser.username;
          currUser.userInfo = getCookie("UserInfo") || currUser.userInfo;
          currUser.username && callback && callback(currUser.username);
        }catch(e){
          log(e);
        }
    },
    initRealtime: function () {
      var self = this;
      // å…¼å®¹ç‹¬ç«‹å’Œåˆå¹¶çš„realtime.js
      if(csdn.RealtimeClient === undefined) {
        $.ajax({
          url: self.staticUrl(self.conf['realtime.js'])
          , dataType: 'script'
          , cache: true // å·²é€šè¿‡staticUrlå¯¹å¤–é“¾æ–‡ä»¶æä¾›äº†ç¼“å­˜æ”¯æŒï¼ŒgetScript()å¯èƒ½ä¼šå§‹ç»ˆåœ¨urlç»“å°¾åŠ æ—¶é—´æˆ³
          , success: arguments.callee.bind(self)
        });
        return;
      }
      self.conf['socket.io.js'] = self.staticUrl(self.conf['socket.io.js']);
      self.realtimeClient = new csdn.RealtimeClient($.extend({
        channel: currUser.username
      }, self.conf), function (msg) {
        // åˆ†å‘æ”¶åˆ°çš„å®æ—¶æ¶ˆæ¯
        if(typeof msg === 'object') {
          if(msg.setReaded) {
            self.emit('receive_setreaded', [msg.setReaded]);
          }
          if(msg.initUnreadIds&&msg.initUnreadIds.length){
            hasNewMsg = true;
            self.emit('receive_unreads', msg);
          }
          if(msg.realtimeMsg){
            hasNewMsg = true;
            localUreadData = localUreadData.concat(msg.data);
            self.emit('receive_unreads', msg);
          }
        }
      });
    },
    /*
    * UBBè½¬ä¹‰
    */
    ubbDecode : function(content){
      var _this = this;
      content = $.trim(content);
      var re = /\[code=([\w#\.]+)\]([\s\S]*?)\[\/code\]/ig;

      function replaceQuote(str) {
        var m = /\[quote=([^\]]+)]([\s\S]*)\[\/quote\]/gi.exec(str);
        if (m) {
            return str.replace(m[0], '<fieldset><legend>å¼•ç”¨â€œ<span class="user_name">' + m[1] + '</span>â€çš„è¯„è®ºï¼š</legend>' + replaceQuote(m[2]) + '</fieldset>');
        } else {
            return str;
        }
      }
      var codelist = [];
      while ((mc = re.exec(content)) != null) {
          codelist.push(mc[0]);
          content = content.replace(mc[0], "--code--");
      }
      content = replaceQuote(content);
      content = content.replace(/\[reply]([\s\S]*?)\[\/reply\][\r\n]{0,2}/gi, "å›å¤<span class='user_name'>$1</span>ï¼š");
      content = content.replace(/\[url=([^\]]+)]([\s\S]*?)\[\/url\]/gi, '<a href="$1" target="_blank">$2</a>');
      content = content.replace(/\[img(=([^\]]+))?]([\s\S]*?)\[\/img\]/gi, '<img src="$3" style="max-width:200px;max-height:100px;" border="0" title="$2" />');
      content = content.replace(/\r?\n/ig, "<br />");

      if (codelist.length > 0) {
          var re1 = /--code--/ig;
          var i = 0;
          while ((mc = re1.exec(content)) != null) {
              content = content.replace(mc[0], codelist[i]);
              i++;
          }
      }
      content = content.replace(/\[code=([\w#\.]+)\]([\s\S]*?)\[\/code\]/ig, function (m0, m1, m2) {
          if ($.trim(m2) == "") return '';
          return '<pre name="code2" class="' + m1 + '">' + _this.HTMLEncode(m2) + '</pre>';
      });

      content = content.replace(/(<br\s\S*>|<br>)/ig, function (m0) {
          if ($.trim(m0) == "") return '';
          //return _this.HTMLEncode(m0);
          return "&nbsp;&nbsp;";
      });
      //é’ˆå¯¹è½¬ä¹‰çš„"åšå¤„ç†
      content = content.replace(/(\\&quote\;|\&quote\;)/ig, function (m0) {
          if ($.trim(m0) == "") return '';
          //return _this.HTMLEncode(m0);
          return "";
      });
      return content;
    },
    HTMLEncode : function(str) {
      var s = "";
      if(str.length == 0) return "";
      s = str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\'/g, "&#39;").replace(/\"/g, "&quot;");
      return s;
    },

    /**
    * ç®€å•æ¨¡æ¿æ›¿æ¢
    * @param  {String} tempStr å¾…æ›¿æ¢å­—ç¬¦ä¸²
    * @return {String}         æ›¿æ¢åçš„html
    */
    feTemplate : function(tempStr){
      // TODO æœªå¤„ç†æ¨¡æ¿å­—æ®µé‡å¤å‡ºç°çš„é—®é¢˜       [fixed]
      //      æœªå¤„ç†è¿”å›çš„æ¨¡æ¿å¯¹è±¡å¤ç”¨çš„é—®é¢˜     [fixed]
      // æµ‹è¯•ç”¨ä¾‹ //jsfiddle.net/SdzfU/2/
      
      return {
          render:function(conf){
            var result=tempStr;
            for(var name in conf){
                if(conf.hasOwnProperty(name)){
                    result=result.replace(new RegExp("{"+"%"+name+"%"+"}","g"),conf[name]);
                }
            }
            return result;
          }
      }
    }
  };

})(window);

(function($, window, undefined) {
  if ($ === undefined) {
    // æŒ‰éœ€åŠ è½½jQuery
    var done = false
      , callback = arguments.callee
      , script = document.createElement('script')
      , head = document.getElementsByTagName('head')[0] || document.documentElement
      ;
    script.src = '//csdnimg.cn/www/js/jquery-1.4.2.min.js';
    script.charset = 'utf-8';
    script.onload = script.onreadystatechange = function () {
      if(!done && (!this.readyState || this.readyState === 'loaded' || this.readyState === 'complete')) {
        done = true;
        try {
          callback(window.jQuery, window);
        } catch(e) {
          window.console && window.console.log(e);
        }

        script.onload = script.onreadystatechange = null;
        if(head && script.parentNode) {
          head.removeChild(script);
        }
      }
    };
    head.insertBefore(script, head.firstChild);
    return;
  }

  // åˆå§‹åŒ–é€šçŸ¥é¢æ¿
  var script = $("#noticeScript")
    , opts = {
      instance: 'csdn_note'
      , btnId: script.attr('btnId') || 'header_notice_num'
      , wrapId: 'note1'
    }
    ;
  opts.btn = $('#' + opts.btnId);
  if(!opts.btn[0]) {
    return;
  }

  $.map(['instance', 'wrapId'
    , 'realtime', 'api', 'app', 'space', 'count', 'subCount'
    , 'staticUrl', 'cssUrl'
    , 'realtime.js', 'channel', 'socket.io.js', 'socket.io options'], function (v) {
    opts[v] = script.attr(v.replace(/[. ]/g, '-')) || opts[v];
  });

  if(opts.instance === "csdn_note") {
    $('\
<div id="note1" class="csdn_note" style="display:none; position:absolute; z-index:9999; width:440px">\
  <span class="notice_top_arrow"><span class="inner"></span></span>\
  <div class="box"></div>\
</div>').insertBefore(script);
  }
  $('\
<div class="csdn_notice_tip" style="display:none; position:absolute; z-index:9990; width:170px">\
  <iframe src="about:blank" frameborder="0" scrolling="no" style="z-index:-1;position:absolute;top:0;left:0;width:100%;height:100%;background:transparent"></iframe>\
  <div class="tip_text">æ‚¨æœ‰<strong>0</strong>æ¡æ–°é€šçŸ¥</div>\
  <a href="javascript:void 0" class="close2"></a>\
</div>').insertBefore(script).hide();

  window[opts.instance] = new csdn.note(opts);

})(window.jQuery, window);
í†¶£P³      UÉ®‰UÉ®v;w!ÿUÒİÖ   5:http://csdnimg.cn/rabbit/notev2/js/notify.js?9d86d94 necko:classified 1 request-method GET response-head HTTP/1.1 200 OK
Server: openresty/1.5.12.1
Date: Tue, 11 Aug 2015 07:25:10 GMT
Content-Type: application/javascript; charset=utf-8
Content-Length: 36707
Last-Modified: Fri, 03 Jul 2015 06:00:18 GMT
Etag: "559624f2-8f63"
Expires: Tue, 18 Aug 2015 07:25:10 GMT
Cache-Control: max-age=604800
Access-Control-Allow-Origin: *
Accept-Ranges: bytes
 uncompressed-len 0   c